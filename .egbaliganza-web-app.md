Egbaliganza Backend & API Technical Documentation
 Version: 1.0
 Framework: Yii2 Advanced Template
Prepared By: Wisdom Diala (Software Engineer)

Table of Contents
Overview


Architecture & Directory Structure


Dependencies & Configuration


Authentication & API Key Management


Content Management Service (CMS)


5.1. Models


5.2. CmsService


5.2.1. savePage()


5.2.2. generateSlug()


5.2.3. deletePage()


5.2.4. getPage()


5.2.5. getSectionContent()


RESTful API for Adverts & Page Sections


6.1. Versioning & Base Controller


6.2. Endpoints


6.2.1. GET /v1/ad-zones


6.2.2. GET /v1/adverts


6.2.3. GET /v1/advert/adzone/<identifier>


Usage Examples


Error Handling & Validation


Testing & Quality Assurance


Opinionated Remarks



Overview
This is a technical documentation of a modular Content Management System (CMS) for dynamic page content along with a RESTful API to expose adverts and page-section content. Built with the Yii2 Advanced Template, it enforces clean separation between frontend, backend, and shared logic, ensuring scalability and maintainability.

Architecture & Directory Structure
/backend                 # Admin interface (Yii2 web)
  /controllers
  /views
  /web
/common                  # Shared models, services, components
  /models
    Page.php
    PageSection.php
  /services
    CmsService.php
/api                     # Versioned API endpoints
  /versions
    /v1
      /controllers
        AdvertsController.php
/frontend                # Public-facing site
/console                 # CLI commands
/vendor                  # Composer dependencies


Dependencies & Configuration
This section outlines both shared and API-specific configuration for the Yii2 Advanced Template, focusing on merging common settings and defining RESTful API components.
// api/config/main.php
$params = array_merge(
    require __DIR__ . '/../../common/config/params.php',
    require __DIR__ . '/../../common/config/params-local.php',
    require __DIR__ . '/params.php',
    require __DIR__ . '/params-local.php'
);

$config = [
    'id' => 'app-api',
    'basePath' => dirname(__DIR__),
    'bootstrap' => ['log'],
    'aliases' => [
        '@api' => dirname(__DIR__),
        '@api/versions' => dirname(__DIR__) . '/versions',
        '@api/versions/v1' => dirname(__DIR__) . '/versions/v1',
    ],
    'modules' => [
        'v1' => [
            'basePath' => '@api/versions/v1',
            'class' => 'api\\versions\\v1\\RestModule',
        ],
    ],
    'apiComponents' => [
        'user' => [
            'identityClass' => 'common\\models\\User',
            'enableAutoLogin' => false,
            'enableSession' => false,
        ],
        'log' => [
            'traceLevel' => YII_DEBUG ? 1 : 0,
            'targets' => [
                [
                    'class' => 'yii\\log\\FileTarget',
                    'levels' => ['error', 'warning'],
                ],
            ],
        ],
        'urlManager' => [
            'enablePrettyUrl' => true,
            'enableStrictParsing' => false,
            'showScriptName' => false,
            'rules' => [
                [
                    'class' => 'yii\\rest\\UrlRule',
                    'controller' => 'v1/deal',
                    'pluralize' => true,
                    'except' => ['delete', 'create', 'update'],
                ],
                '' => 'v1/site/index',
                'GET v1/ad-zones' => 'v1/adverts/adzones',
                'GET v1/adverts' => 'v1/adverts/adverts',
                'GET v1/adverts/<identifier>' => 'v1/adverts/by-zone',
            ],
        ],
        'request' => [
            'parsers' => [
                'application/json' => 'yii\\web\\JsonParser',
            ],
            'enableCookieValidation' => false,
            'enableCsrfValidation' => false,
        ],
        'response' => [
            'format' => yii\\web\\Response::FORMAT_JSON,
            'charset' => 'UTF-8',
        ],
    ],
    'params' => $params,
];

// Merge with common config
$commonMain = require __DIR__ . '/../../common/config/main.php';
$commonLocal = require __DIR__ . '/../../common/config/main-local.php';

$commonConfig = array_merge(
    $commonMain,
    $commonLocal
);

// Combine API and common settings
$finalConfig = array_merge(
    $commonConfig,
    $config
);
$finalConfig['components'] = array_merge(
    $finalConfig['components'] ?? [],
    $finalConfig['apiComponents']
);
unset($finalConfig['apiComponents']);  

return $finalConfig;

Key Points:
Parameter Merging: Combines global (common/config) and environment-specific (params-local.php) parameters to support multiple environments.


Aliases: Defines @api, @api/versions, and versioned aliases for easier path resolution.


Modules: Registers v1 module under api/versions/v1 using RestModule class.


Components Separation: Stores API-specific components under apiComponents key, then merges into the main components array after loading common settings.


URL Manager: Configures RESTful routing, including UrlRule for deal, custom rules for adverts endpoints, and pretty URLs without index.php.


Request & Response: Disables session-based auth, CSRF for API, JSON parser for application/json, and forces JSON response format.


Logging: Uses file target for error and warning logs, with trace level controlled by YII_DEBUG.


This configuration ensures a clear separation between shared and API-specific settings, maintains DRY principles, and supports versioned API development.


Authentication & API Key Management
To secure all API endpoints with per-user credentials, an API key mechanism was implemented via the User model and enforced globally in BaseActiveController.
User Model Extensions
/**
 * Generates a new API key, hashes it, and saves to the database.
 * @return string|null Raw token ("{base64(userId)}.{rawKey}"), or null on failure.
 */
public function generateApiKey(): ?string
{
    $rawKey = Yii::$app->security->generateRandomString(32);
    // Prefix the raw key with base64-encoded user ID
    $token  = base64_encode($this->id) . '.' . $rawKey;

    // Store only the hashed key
    $this->api_key = password_hash($rawKey, PASSWORD_DEFAULT);
    $this->save(false);

    return $token;
}

/**
 * {@inheritdoc}
 */
public static function findIdentityByAccessToken($token, $type = null)
{
    if (!preg_match('/^([A-Za-z0-9_\-]+=*)\.([\w\-]{32,})$/', $token, $m)) {
        return null;
    }
    $userId = base64_decode($m[1]);
    $rawKey = $m[2];

    $user = static::findOne([
        'id'     => $userId,
        'status' => self::STATUS_ACTIVE,
    ]);
    // Prevent admins using this method
    if (Yii::$app->user->can(RbacHelper::ROLE_SITE_ADMIN)) {
        return null;
    }

    return ($user && password_verify($rawKey, $user->api_key)) ? $user : null;
}

Key Points:
Token Structure: {base64(userId)}.{rawKey} ensures stateless user lookup without exposing plain user IDs.


Security: Only the hash of the raw key is stored, using PHP’s password_hash().


Validation: findIdentityByAccessToken() parses the token, retrieves the user by decoded ID, and verifies the hash.


Enforcing API Key Validation
All versioned API controllers inherit from BaseActiveController, which overrides behaviors() to require a valid API key on every request:
public function behaviors()
{
    $behaviors = parent::behaviors();

    // Remove default session/cookie authentication
    unset($behaviors['authenticator']);

    // Add CompositeAuth with HttpHeaderAuth
    $behaviors['authenticator'] = [
        'class'       => CompositeAuth::class,
        'authMethods' => [
            [
                'class'  => HttpHeaderAuth::class,
                'header' => 'X-API-KEY',
            ],
        ],
    ];

    return $behaviors;
}

Key Points:
CompositeAuth: Allows future extension (e.g., QueryParamAuth).


HttpHeaderAuth: Expects X-API-KEY header carrying the raw token.


Global Enforcement: All endpoints return 401 Unauthorized if API key is missing or invalid.



Content Management Service (CMS)
Models
Page
 Represents a web page. Key attributes:


id (PK)


title (string)


slug (string, unique)


PageSection


id (PK), page_id (FK→Page), key (string), type (enum:text,image), content (text/file path)


CmsService
Located in common/services/CmsService.php, all operations occur within transactions to maintain data integrity.
4.2.1. savePage(array $data, ?Page $page = null): Page
Purpose: Create/update a Page and its PageSections.


Flow:


Begin transaction.


Generate slug via generateSlug() if missing.


Load and save Page.


Iterate and save each section.


Commit or roll back on error.


Errors: Throws on validation/persistence failures.


4.2.2. generateSlug(string $title): string
Lowercase, trim, replace spaces with hyphens, strip invalid chars.


Append numeric suffix until unique in DB.


4.2.3. deletePage(int $id): void
Finds and deletes the Page (cascading to sections).


4.2.4. getPage(string $slug): ?Page
Returns a Page with sections eagerly loaded, or null.


4.2.5. getSectionContent(string $slug, string $sectionKey): ?string
Fetches a specific section’s content.


If type==='image', prefixes path with @frontendUrl.



RESTful API for Adverts & Page Sections
5.1. Versioning & Base Controller
All controllers extend api\versions\v1\BaseActiveController, which configures JSON format, auth, and CORS.
5.2. Endpoints
5.2.1. GET /v1/ad-zones
Retrieve all ad zones:
json
CopyEdit
{ "success": true, "data": [ { "id":1, "name":"Header", "slug":"header" }, … ] }

5.2.2. GET /v1/adverts
List all active adverts, including minimal adzone info.
5.2.3. GET /v1/advert/adzone/<identifier>
Fetch adverts scoped to a specific zone, using numeric ID or slug.

Authentication & API‑Key Validation
6.1. User Model: Key Generation & Verification
php
CopyEdit
public function generateApiKey(): ?string
{
    $rawKey = Yii::$app->security->generateRandomString(32);
    $token  = base64_encode((string)$this->id) . '.' . $rawKey;
    $this->api_key = password_hash($rawKey, PASSWORD_DEFAULT);
    $this->save(false);
    return $token;
}


public static function findIdentityByAccessToken($token, $type = null)
{
    if (!preg_match('/^([A-Za-z0-9_\-]+=*)\.([\w\-]{32,})$/',$token,$m)) {
        return null;
    }
    $userId = (int)base64_decode($m[1]);
    $rawKey = $m[2];
    $user = static::findOne(['id'=>$userId,'status'=>self::STATUS_ACTIVE]);
    // Prevent site-admin via API key if needed
    if ($user && Yii::$app->user->can(RbacHelper::ROLE_SITE_ADMIN)) {
        return null;
    }
    return ($user && password_verify($rawKey,$user->api_key)) ? $user : null;
}

6.2. Base Controller: Enforcing Key Validation
php
CopyEdit
class BaseActiveController extends ActiveController
{
    public function behaviors()
    {
        $behaviors = parent::behaviors();
        unset($behaviors['authenticator']);
        $behaviors['authenticator'] = [
            'class'       => CompositeAuth::class,
            'authMethods' => [[
                'class'  => HttpHeaderAuth::class,
                'header' => 'X-API-KEY',
            ]],
        ];
        return $behaviors;
    }
}

Flow: HttpHeaderAuth extracts X-API-KEY → findIdentityByAccessToken() → allow or 401.


Opinion: Header-based auth is clean; consider rate-limiting and optional query‑param fallback with caution.



Usage Examples
bash
CopyEdit
# Generate API key for user (backend console/endpoint)
POST /v1/user/<id>/generate-api-key


# Fetch ad zones (must include X-API-KEY header)
curl -H "X-API-KEY: <token>" https://api.example.com/v1/ad-zones


# Fetch adverts in sidebar zone
curl -H "X-API-KEY: <token>" \
  https://api.example.com/v1/advert/adzone/sidebar


Error Handling & Validation
400 Bad Request: Validation errors.


401 Unauthorized: Missing/invalid API key.


404 Not Found: Invalid resource.


500 Server Error: Unexpected failures.


Error format:
json
CopyEdit
{
  "success": false,
  "error": { "code": 401, "message": "Unauthorized" }
}


Testing & Quality Assurance
Unit Tests:


tests/unit/services/CmsServiceTest.php


tests/unit/models/UserApiKeyTest.php


Integration Tests:


tests/codeception/api/AdvertsCest.php


tests/codeception/api/AuthenticationCest.php




